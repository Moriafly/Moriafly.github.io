(window.webpackJsonp=window.webpackJsonp||[]).push([["CoachmarkData"],{QnRU:function(e,t,a){"use strict";a.d(t,"a",(function(){return O})),a.d(t,"c",(function(){return j})),a.d(t,"b",(function(){return w}));var r=a("D57K"),i=a("tMmC"),s=a("a0gC");const n=new class{getAllCampaigns(){return new Promise(e=>Object(r.b)(this,void 0,void 0,(function*(){try{(yield s.a.isUserNurturingApiAvailableToUse())?s.a.getUserNurturingPreferenceSetting("campaigns").then(t=>{t||i.a.logError("PSL: window.chrome.ntpSettingsPrivate.getPref does not have campaigns."),e(t||[])}):(i.a.logError("PSL: Error fetching campaigns due to window.chrome.ntpSettingsPrivate.getPref api not available for this version of EDGE"),e([]))}catch(t){i.a.logError(t),e([])}})))}persistCampaigns(e){return new Promise(t=>Object(r.b)(this,void 0,void 0,(function*(){try{(yield s.a.isUserNurturingApiAvailableToUse())?(yield s.a.saveUserNurturingPreferenceSetting("campaigns",e),i.a.log(`PSL: Number of campaigns persisted: ${e.length||0}.`),t(!0)):i.a.logError("PSL: Error persisting campaigns due to window.chrome.ntpSettingsPrivate.getPref api not available for this version of EDGE")}catch(e){i.a.logError(e)}t(!1)})))}clearPersistentStorage(){return this.persistCampaigns([])}};var o=a("dTwT");const c=new class{constructor(){this.storageKey="irisNewsLocalStorage"}getAllCampaigns(){try{return o.a.getObject(this.storageKey)}catch(e){return i.a.logError(`Exception ${e} occurred retrieving user nurturing campaigns from local storage`),[]}}storeCampaigns(e){try{return o.a.setObject(this.storageKey,e),i.a.log(`Number of campaigns persisted in local storage: ${e.length||0}.`),!0}catch(e){return i.a.logError(`Exception ${e} occurred storing user nurturing campaigns in local storage`),!1}}clearLocalStorage(){return this.storeCampaigns([])}};var u=a("HxRh"),d=a("rvYQ"),g=a("ADRF"),h=a("y+Kz"),f=a("I6Lx"),l=a("ypwz"),m=a("s9+9"),p=a("KRKw"),b=a("tERu"),v=a("ljWX"),C=a("VZ41"),I=a("XgsJ"),S=a("HDSB"),y=a("9J8d"),E=a("gqHb"),A=a("XLvf");const O=new class{constructor(){this.cachedSurfaceMap=new Map,this.millisecondsInADay=864e5,this.timeNow=(new Date).getTime(),this.enabledFeatures=[],this.appType=d.b&&d.b.AppType,this.appType===l.a.EdgeChromium&&this.getConfigDataAsync()}get isEnabled(){return!!this.shouldUseCache()||!(!this.irisDataConfig||!this.irisDataConfig.enableCaching)&&this.isCookieConsentNotRequired()}set IrisDataConfig(e){this.irisDataConfig=e}clearCachedSurfaceMap(){this.isEnabled&&this.cachedSurfaceMap.clear()}populateCachedSurfaceMap(){return Object(r.b)(this,void 0,void 0,(function*(){if(this.isEnabled)try{if(this.purgeCacheWithQsp())return yield this.clearCachedSurfacesFromStorage(),void i.a.log("Cache purged!");this.clearCachedSurfaceMap();let e=[];if(e=d.b.AppType===l.a.EdgeChromium?yield n.getAllCampaigns():c.getAllCampaigns(),!e||0===e.length)return void i.a.log("Bulk read of surfaces from local/persistent storage didn't return a surface.");const{subscribers:t}=this.irisDataConfig,a=[];Object.keys(t).forEach(e=>{t[e].active||a.push(v.b[e])}),e.forEach(e=>{e&&e.placement&&(0===a.length||-1===a.indexOf(e.placement))&&(i.a.log(`Populated ${e.placement} from local/persistent storage.`),this.cachedSurfaceMap.set(e.placement,e),this.highestLastAddedTime=0,e.creatives&&e.creatives.length>0&&e.creatives.forEach(e=>{e&&e.storageInfo&&e.storageInfo.lastAddedTime&&(this.highestLastAddedTime=e.storageInfo.lastAddedTime>=this.highestLastAddedTime?e.storageInfo.lastAddedTime:this.highestLastAddedTime)}))})}catch(e){i.a.logError("Bulk read of surfaces from local/persistent storage threw error: "+e)}}))}getLatestCachedSurface(e,t){if(!e||0===e.length||0===this.cachedSurfaceMap.size)return null;if(!this.cachedSurfaceMap.has(e))return null;const a=this.cachedSurfaceMap.get(e);if(!a||!a.creatives||0===a.creatives.length)return null;if(t!==v.c.MSNAnaheimNewsNTPImages)return a;const r=this.getStorageCachingExpiration();let i=!1;return a.creatives.forEach(e=>{e&&e.storageInfo&&e.storageInfo.lastAddedTime&&this.timeNow-e.storageInfo.lastAddedTime<r&&(i=!0)}),i?a:null}addSurfaceToMap(e){if(!e||!e.placement)return;const t=e.placement,a=new Map;if(this.cachedSurfaceMap.has(t)){this.cachedSurfaceMap.get(t).creatives.forEach(e=>{a.set(e.creativeId,e)})}e.creatives&&e.creatives.forEach(e=>{const t={useCount:0,lastAddedTime:this.timeNow};e.storageInfo=t,a.set(e.creativeId,e)}),e.creatives=[...a.values()],i.a.log(`Adding SurfaceInfo ${t} in storage.`),this.cachedSurfaceMap.set(t,e)}addSurfaceCollectionToStorage(e){return Object(r.b)(this,void 0,void 0,(function*(){e&&e.length>0&&(e.forEach(e=>{e.placement!==v.b[v.c.MSNAnaheimNewsNTPImages]&&e.placement!==v.b[v.c.MSNAnaheimNewsNTPImages+v.a]&&this.addSurfaceToMap(e)}),yield this.persistAllSurfaces())}))}persistAllSurfaces(){return Object(r.b)(this,void 0,void 0,(function*(){if(this.isEnabled){if(d.b.AppType===l.a.EdgeChromium)return void(yield n.persistCampaigns([...this.cachedSurfaceMap.values()]));c.storeCampaigns([...this.cachedSurfaceMap.values()])}}))}clearCachedSurfacesFromStorage(){return Object(r.b)(this,void 0,void 0,(function*(){this.isEnabled&&(this.clearCachedSurfaceMap(),d.b.AppType!==l.a.EdgeChromium?c.clearLocalStorage():yield n.clearPersistentStorage())}))}getCachedSurfaceMap(){return this.cachedSurfaceMap}HaveWeShownASurfaceRecently(){return this.highestLastAddedTime>0&&this.timeNow-this.highestLastAddedTime<this.getTimeBetweenShowingDifferentCreatives()}isUserSeenAllCreativesInSurface(e){if(!e||0===e.length)return!1;if(this.cachedSurfaceMap.has(e)){const t=this.cachedSurfaceMap.get(e);let a=0;if(t&&t.creatives&&t.creatives.length>0)return t.creatives.forEach(e=>{e.storageInfo&&e.storageInfo.useCount&&e.storageInfo.lastAddedTime&&(e.storageInfo.useCount>=this.getReshowingCounterForEachCreative()||this.timeNow-e.storageInfo.lastAddedTime<=this.getTimeBetweenReshowingSameCreative())&&a++}),t.creatives.length===a}return!1}filterCreatives(e){if(!e||!this.shouldUseMaximumCapPerCreative())return e;const t=this.irisDataConfig&&this.irisDataConfig.maximumCapPerCreative||2,a=[];return e.creatives.forEach(e=>{e.storageInfo&&e.storageInfo.useCount<=t&&a.push(e)}),e.creatives=a,e}updateAction(e,t,a){if(e&&t&&this.cachedSurfaceMap.has(e)){const r=this.cachedSurfaceMap.get(e);r&&r.creatives&&r.creatives.forEach(e=>{e.creativeId===t&&e.storageInfo&&(e.storageInfo.irisAction=a)})}}markCreativeAsSeenByUser(e,t){if(e&&t&&this.cachedSurfaceMap.has(e)){const a=this.cachedSurfaceMap.get(e);a&&a.creatives&&a.creatives.forEach(e=>{e&&e.creativeId&&e.creativeId===t&&e.storageInfo&&(e.storageInfo.useCount++,e.storageInfo.lastAddedTime=this.timeNow)})}}hasUserDismissedAllStoredSurfaceCreatives(e){if(!e||0===e.length)return!1;if(this.cachedSurfaceMap.has(e)){const t=this.cachedSurfaceMap.get(e);let a=0;if(t&&t.creatives&&t.creatives.length>0)return t.creatives.forEach(e=>{if(!e.storageInfo||!e.storageInfo.irisAction||e.storageInfo.irisAction!==C.a.Dismiss)return!1;a++}),t.creatives.length===a}return!1}updateCreativeLatestAddedTime(e,t,a){if(!this.cachedSurfaceMap.has(e))return;const r=this.cachedSurfaceMap.get(e);r&&r.creatives&&0!==r.creatives.length&&r.creatives.forEach(e=>{e&&e.creativeId===t&&e.storageInfo&&e.storageInfo.lastAddedTime&&(e.storageInfo.lastAddedTime=a)})}getStorageCachingExpiration(){return(this.irisDataConfig&&this.irisDataConfig.storageCachingExpiration||1)*this.millisecondsInADay}getReshowingCounterForEachCreative(){return this.irisDataConfig&&this.irisDataConfig.frequency||2}getTimeBetweenReshowingSameCreative(){return(this.irisDataConfig&&this.irisDataConfig.frequencyInterval||14)*this.millisecondsInADay}getTimeBetweenShowingDifferentCreatives(){return(this.irisDataConfig&&this.irisDataConfig.frequencyIntervalBetweenCreatives||1)*this.millisecondsInADay}purgeCacheWithQsp(){const e=Object(I.n)();if(e){const t=g.a.getQueryParameterByName("purgeCache",e);if(t&&"true"===t.toLocaleLowerCase())return!0}return!1}shouldUseCache(){const e=Object(I.n)();if(e){const t=g.a.getQueryParameterByName("useCache",e);if(t)return"true"===t.toLocaleLowerCase()}return!1}shouldUseMaximumCapPerCreative(){const e=Object(I.n)();if(e){const t=g.a.getQueryParameterByName("useMaxCapPerCreative",e);if(t)return"true"===t.toLocaleLowerCase()}return!0}isCookieConsentNotRequired(){const e=y.a.getInstance().rootReducer.connector(m.a.SharedState),t=e&&e.getCurrentState();return(t&&t.cookieConsentStatus)===p.b.NotRequired}getConfigDataAsync(){return Object(r.b)(this,void 0,void 0,(function*(){return this.getConfigDataPromise=new Promise(e=>{try{Object(S.a)()&&window&&window.chrome&&window.chrome.ntpSettingsPrivate&&"function"==typeof window.chrome.ntpSettingsPrivate.getConfigData?window.chrome.ntpSettingsPrivate.getConfigData(t=>{void 0!==t?(this.profileCreationTimeInMs=t.profileCreationTime,this.enabledFeatures=t.enabledFeatures,e()):(E.a.trackAppErrorEvent(Object.assign(Object.assign({},u.bb),{message:"Config data is undefined"})),e())}):(E.a.trackAppErrorEvent(Object.assign(Object.assign({},u.Kb),{message:"Failed to fetch config data from chromium API"})),e())}catch(t){E.a.trackAppErrorEvent(Object.assign(Object.assign({},u.Fb),{message:"Exception fetching config data from chromium API",pb:Object.assign(Object.assign({},u.Fb.pb),{customMessage:"Exception: "+t})})),e()}}),this.getConfigDataPromise}))}isBlackoutPeriodOver(){return Object(r.b)(this,void 0,void 0,(function*(){this.appType===l.a.EdgeChromium&&(yield this.getConfigDataPromise);const e=this.irisDataConfig.blackoutPeriodInDays&&this.irisDataConfig.blackoutPeriodInDays*this.millisecondsInADay||7*this.millisecondsInADay;return!!this.profileCreationTimeInMs&&this.timeNow-this.profileCreationTimeInMs>e}))}isNurturingEnabled(){return Object(r.b)(this,void 0,void 0,(function*(){return this.appType===l.a.EdgeChromium&&(yield this.getConfigDataPromise),!!this.enabledFeatures&&this.enabledFeatures.indexOf("msUserNurturing")>=0}))}};function j(){return Object(r.b)(this,void 0,void 0,(function*(){if(yield w())return!1;try{return!1!==o.a.getObject(h.u)}catch(e){return E.a.trackAppErrorEvent(Object.assign(Object.assign({},u.Nb),{message:"Failed to fetch nurturing accepted key from local storage",pb:Object.assign(Object.assign({},u.Nb.pb),{customMessage:`Exception: ${e} occurred while reading key: ${h.u} from local storage.`})})),!1}}))}function w(){return Object(r.b)(this,void 0,void 0,(function*(){yield d.b.AccountInfoPromise;const e=d.b.ResolvedAccountInfo;return Object(A.isNullOrUndefined)(f.b.AadState)?b.b.AAD===(e&&e.account_type):f.b.AadState}))}},U6Xm:function(e,t,a){"use strict";a.d(t,"a",(function(){return i}));var r=a("G82u");class i{}i.addCoachmark=new r.a("AddCoachmark"),i.updateCoachmarkVisibleStatus=new r.a("UpdateCoachmarkVisibleStatus")},g7TJ:function(e,t,a){"use strict";a.r(t),a.d(t,"CoachmarkDataActions",(function(){return n.a})),a.d(t,"CoachmarkDataReducer",(function(){return C})),a.d(t,"CoachmarkDataConnector",(function(){return b})),a.d(t,"CoachmarkPayload",(function(){return r.a})),a.d(t,"CoachmarkPlacement",(function(){return r.b})),a.d(t,"CoachmarkPointerPosition",(function(){return r.c})),a.d(t,"CoachmarkSource",(function(){return r.d})),a.d(t,"FloatingCoachmarkPosition",(function(){return r.e})),a.d(t,"IrisAction",(function(){return i.a})),a.d(t,"IrisSurfaceName",(function(){return s.c})),a.d(t,"IrisTelemetryEventType",(function(){return i.b})),a.d(t,"RegisterErrorTrackingCallback",(function(){return l.a})),a.d(t,"ToolingInfo",(function(){return I}));var r=a("rcIs"),i=a("VZ41"),s=a("ljWX"),n=a("U6Xm"),o=a("D57K"),c=a("1w6q"),u=a("HxRh"),d=a("tMmC"),g=a("z5Om"),h=a("s9+9"),f=a("9J8d"),l=a("MLMI");class m{static getCoachmarksFromDataConnector(e){return Object(o.b)(this,void 0,void 0,(function*(){if(this.irisDataConnector=yield f.a.getInstance().rootReducer.getDataConnector(h.a.IrisData),!this.irisDataConnector)return l.a.trackAppErrorEvent(Object.assign(Object.assign({},u.Q.IrisDataConnectorUndefined),{message:"No Iris data connector"})),null;const t=yield this.irisDataConnector.getPayload(e);if(!this.validateSurface(t,e))return null;const a=t.creatives,r=a[Math.floor(Math.random()*a.length)];return this.extractCoachmarkCreativeMessages(r,t.placement)}))}static fireIrisBeacon(e,t,a,r,i){return Object(o.b)(this,void 0,void 0,(function*(){this.irisDataConnector=yield f.a.getInstance().rootReducer.getDataConnector(h.a.IrisData),this.irisDataConnector?this.irisDataConnector.sendActionUpdate(i,r,e,t,a):l.a.trackAppErrorEvent(Object.assign(Object.assign({},u.Q.IrisDataConnectorUndefined),{message:"No Iris data connector",pb:Object.assign(Object.assign({},u.Q.EventTypeUndefined.pb),{customMessage:`Error reporting iris beacons eventType: ${e}, telemetryInfo: ${t}, irisAction: ${a}, creativeId: ${r}, placementId:${i}`})}))}))}static validateSurface(e,t){return e?!g.a.infoHasErrors(e)||(e.errors.forEach(e=>{2040!=e.code&&l.a.trackAppErrorEvent(Object.assign(Object.assign({},u.Q.ErrorFoundForSurface),{message:"Surface errors discovered",pb:Object.assign(Object.assign({},u.Q.ErrorFoundForSurface.pb),{customMessage:"Error with surface: "+s.c.MSNNewsCoachmark+" Code: "+e.code+" Message: "+e.msg})}))}),!1):(d.a.log("IrisHandler: Iris surface not found for the campaign: "+e),!1)}static extractCoachmarkCreativeMessages(e,t){const a=[];let i;return e&&e.content&&e.telemetry&&e.creativeId&&t&&(e.content.cm?e.content.cm.forEach(s=>{i=Object.assign(Object.assign({},s),{ctaList:s.cta,timeoutMilliseconds:Number(s.timeoutMilliseconds),eventUrl:e.telemetry,coachmarkSource:r.d.Iris,creativeId:e.creativeId,placementId:t,frequency:Number(e.content.frequency),frequencyInterval:Number(e.content.frequencyInterval)}),a.push(i)}):(i=Object.assign(Object.assign({},e.content),{timeoutMilliseconds:Number(e.content.timeoutMilliseconds),eventUrl:e.telemetry,coachmarkSource:r.d.Iris,creativeId:e.creativeId,placementId:t,frequency:Number(e.content.frequency),frequencyInterval:Number(e.content.frequencyInterval)}),a.push(i))),a}}var p=a("QnRU");class b extends c.a{addCoachmark(e){return Object(o.b)(this,void 0,void 0,(function*(){let t=!1;if(yield Object(p.c)()){const a=r.a.extractMessages(e);if(!a||0===a.length)return!1;const i=new Promise(e=>{n.a.updateCoachmarkVisibleStatus.registerObserver(()=>{t=this.getCurrentState().isCoachmarkOnScreen,e()})});n.a.addCoachmark.getActionSender(this).send(a),yield i}return t}))}reportEvent(e,t,a,r,s){e?t?e!==i.b.Action||a?m.fireIrisBeacon(e,t,a,r,s):l.a.trackAppErrorEvent(Object.assign(Object.assign({},u.Q.IrisActionUndefined),{message:"Iris action undefined",pb:Object.assign(Object.assign({},u.Q.EventTypeUndefined.pb),{customMessage:`Error reporting iris beacons eventType: ${e}, telemetryInfo: ${JSON.stringify(t)}, irisAction: ${a}, creativeId: ${r}, placementId: ${s}`})})):l.a.trackAppErrorEvent(Object.assign(Object.assign({},u.Q.TelemetryInfoUndefined),{message:"Iris telemetry info not found",pb:Object.assign(Object.assign({},u.Q.EventTypeUndefined.pb),{customMessage:`Error reporting iris beacons eventType: ${e}, telemetryInfo: ${JSON.stringify(t)}, irisAction: ${a}, creativeId: ${r}, placementId: ${s}`})})):l.a.trackAppErrorEvent(Object.assign(Object.assign({},u.Q.EventTypeUndefined),{message:"Event type is undefined",pb:Object.assign(Object.assign({},u.Q.EventTypeUndefined.pb),{customMessage:`Error reporting iris beacons eventType: ${e}, telemetryInfo: ${JSON.stringify(t)}, irisAction: ${a}, creativeId: ${r}, placementId: ${s}`})}))}getCoachmarks(e){return Object(o.b)(this,void 0,void 0,(function*(){return yield m.getCoachmarksFromDataConnector(e)}))}}var v=a("05Au");class C{reduce(e,t){if(!e)return{coachmarkMessages:void 0,isCoachmarkOnScreen:void 0};if(!t)return e;let a,r=!1;return r=r||v.a.handleAction(t,n.a.addCoachmark,t=>{a=Object.assign(Object.assign({},e),{coachmarkMessages:t})}),r=r||v.a.handleAction(t,n.a.updateCoachmarkVisibleStatus,t=>{a=Object.assign(Object.assign({},e),{isCoachmarkOnScreen:t})}),a||e}}const I={experienceConfigSchema:{}}}}]);